# Detect Tag Changes Script

## Overview

`detect_tag_changes.rb` is a Ruby script that detects changes in normative tags extracted from AsciiDoc files. It compares two tag JSON files (typically generated by the `tags.rb` converter) and reports additions, deletions, and modifications.

## Usage

```bash
./detect_tag_changes.rb [options] OLD_TAGS.json NEW_TAGS.json
```

### Options

- `-v, --verbose` - Enable verbose output
- `-t, --show-text` - Show tag text in the output (displays the actual content of tags)
- `-o, --output FILE` - Export changes to a JSON file
- `-h, --help` - Show help message

### Exit Codes

- `0` - No changes detected
- `1` - Changes detected (useful for CI/CD pipelines)

## Examples

### Basic Usage

Compare two tag files:
```bash
./detect_tag_changes.rb build/old-tags.json build/new-tags.json
```

### Show Tag Text

Display the actual text content of changed tags:
```bash
./detect_tag_changes.rb --show-text build/old-tags.json build/new-tags.json
```

### Export to JSON

Save changes to a JSON file for further processing:
```bash
./detect_tag_changes.rb --output changes.json build/old-tags.json build/new-tags.json
```

### Combined Options

Use multiple options together:
```bash
./detect_tag_changes.rb -t -o changes.json old.json new.json
```

## Output Format

### Console Output

The script provides a formatted report showing:

1. **Added Tags**: Tags present in the new file but not in the old file
2. **Deleted Tags**: Tags present in the old file but not in the new file
3. **Modified Tags**: Tags present in both files but with different text content
4. **Summary**: Count of total changes, additions, deletions, and modifications

Example output:
```
================================================================================
Tag Changes Report
================================================================================
Old file: build/test-norm-tags-v1.json
New file: build/test-norm-tags-v2.json
================================================================================

Added Tags (1):
--------------------------------------------------------------------------------
  + norm:new-tag

Deleted Tags (1):
--------------------------------------------------------------------------------
  - norm:inline-with-hash

Modified Tags (1):
--------------------------------------------------------------------------------
  ~ norm:inline

================================================================================
Summary: 3 total changes
  Added:    1
  Deleted:  1
  Modified: 1
================================================================================
```

### JSON Export Format

When using the `--output` option, the script generates a JSON file with this structure:

```json
{
  "summary": {
    "total_changes": 3,
    "added": 1,
    "deleted": 1,
    "modified": 1
  },
  "added": {
    "tag-name": "tag text content"
  },
  "deleted": {
    "tag-name": "tag text content"
  },
  "modified": {
    "tag-name": {
      "old": "original text",
      "new": "updated text"
    }
  }
}
```

## Use Cases

### Version Control

Track changes to normative tags across document versions:
```bash
./detect_tag_changes.rb docs-v1.0-tags.json docs-v1.1-tags.json
```

### CI/CD Integration

Use in continuous integration to detect unintended changes:
```bash
if ./detect_tag_changes.rb baseline-tags.json current-tags.json; then
    echo "No changes detected"
else
    echo "Tag changes detected - review required"
    exit 1
fi
```

### Review Process

Generate a JSON report for automated analysis or review:
```bash
./detect_tag_changes.rb \
    --output review/tag-changes.json \
    --show-text \
    previous-release/tags.json \
    current/tags.json
```

## Integration with Existing Tools

This script works seamlessly with the existing RISC-V documentation toolchain:

1. **Generate tags** from AsciiDoc using `tags.rb` converter:
   ```bash
   asciidoctor -r ./converters/tags.rb -b tags document.adoc
   ```

2. **Compare tags** between versions:
   ```bash
   ./detect_tag_changes.rb document-v1.tags.json document-v2.tags.json
   ```

3. **Create normative rules** using `create_normative_rules.rb` with reviewed tags

## Requirements

- Ruby (version 2.7 or later recommended)
- JSON gem (part of Ruby standard library)

No additional dependencies required.

## Error Handling

The script handles common errors gracefully:

- **File not found**: Reports which file is missing
- **Invalid JSON**: Shows parsing error details
- **Invalid arguments**: Displays help message

## Testing

A test scenario is included in the repository:

```bash
# Create test files (these commands create modified versions)
cp build/test-norm-tags.json build/test-v1.json
# ... modify test-v2.json ...

# Run tests
./detect_tag_changes.rb build/test-v1.json build/test-v2.json
./detect_tag_changes.rb --show-text build/test-v1.json build/test-v2.json
./detect_tag_changes.rb --output test-changes.json build/test-v1.json build/test-v2.json
```

## Contributing

When modifying this script:

1. Maintain backward compatibility with existing tag JSON format
2. Add tests for new features
3. Update this README with new options or examples
4. Follow Ruby style guidelines (frozen_string_literal, snake_case, etc.)

## License

This script is part of the RISC-V documentation resources and follows the same license as the parent project.
