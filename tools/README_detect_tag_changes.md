# Detect Tag Changes Script

## Overview

`detect_tag_changes.rb` is a Ruby script that detects changes in normative tags extracted from AsciiDoc files. It compares two tag JSON files (typically generated by the `tags.rb` converter) and reports additions, deletions, and modifications.

## Usage

```bash
./detect_tag_changes.rb [options] REFERENCE_TAGS.json CURRENT_TAGS.json
```

### Options

- `-u, --update-reference` - Update the reference tags file by adding any additions found in the current file
- `-v, --verbose`          - Show verbose output with detailed processing information
- `-h, --help`             - Show help message

### Exit Codes

- `0` - No changes detected or only additions detected
- `1` - Modifications or deletions detected (useful for CI/CD pipelines to flag breaking changes)

## Examples

### Basic Usage

Compare two tag files:
```bash
./detect_tag_changes.rb build/reference-tags.json build/current-tags.json
```

### Update Reference File

Automatically merge additions into the reference file:
```bash
./detect_tag_changes.rb reference.json current.json --update-reference
```

This updates `reference.json` by adding any new tags that are in `current.json` but not in `reference.json`. Useful for maintaining a reference that incorporates new additions.

### Combined Options

Use multiple options together:
```bash
./detect_tag_changes.rb -u -v reference.json current.json
```

### Verbose Mode

Get detailed processing information during execution:
```bash
./detect_tag_changes.rb --verbose reference.json current.json
```

Verbose output includes:
- File loading progress and tag counts
- Change detection progress
- Detailed information about each added tag during updates
- Step-by-step processing information

Useful for debugging, understanding script behavior, or monitoring long-running operations.

## Output Format

### Console Output

The script provides a formatted report showing:

1. **Added Tags**: Tags present in the current file but not in the reference file
2. **Deleted Tags**: Tags present in the reference file but not in the current file
3. **Modified Tags**: Tags present in both files but with different text content
4. **Summary**: Count of total changes, additions, deletions, and modifications

Example output:
```
================================================================================
Tag Changes Report
================================================================================
Reference file: build/test-norm-tags-v1.json
Current file: build/test-norm-tags-v2.json
================================================================================

Added Tags (1):
--------------------------------------------------------------------------------
  + norm:new-tag

Deleted Tags (1):
--------------------------------------------------------------------------------
  - norm:inline-with-hash

Modified Tags (1):
--------------------------------------------------------------------------------
  ~ norm:inline

================================================================================
Summary: 3 total changes
  Added:    1
  Deleted:  1
  Modified: 1
================================================================================
```

## Use Cases

### Version Control

Track changes to normative tags across document versions:
```bash
./detect_tag_changes.rb docs-v1.0-tags.json docs-v1.1-tags.json
```

### CI/CD Integration

Use in continuous integration to detect unintended changes:
```bash
if ./detect_tag_changes.rb reference-tags.json current-tags.json; then
    echo "No changes detected"
else
    echo "Tag changes detected - review required"
    exit 1
fi
```

### Review Process

Generate a detailed report for review:
```bash
./detect_tag_changes.rb \
    --show-text \
    previous-release/tags.json \
    current/tags.json
```

### Reference Maintenance

Maintain a reference that automatically incorporates new additions:
```bash
# Check for changes and update reference with new tags
./detect_tag_changes.rb \
    --update-reference \
    reference-tags.json \
    current-tags.json

# Exit code 1 means modifications/deletions detected (needs review)
# Exit code 0 means no changes or only additions (reference auto-updated)
```

This workflow is useful in CI/CD pipelines where:
- New tags in the current file are automatically merged into the reference
- Modifications or deletions trigger alerts for manual review
- The reference always stays up-to-date with approved additions

## Integration with Existing Tools

This script works seamlessly with the existing RISC-V documentation toolchain:

1. **Generate tags** from AsciiDoc using `tags.rb` converter:
   ```bash
   asciidoctor -r ./converters/tags.rb -b tags document.adoc
   ```

2. **Compare tags** between versions:
   ```bash
   ./detect_tag_changes.rb document-v1.tags.json document-v2.tags.json
   ```

3. **Create normative rules** using `create_normative_rules.rb` with reviewed tags

## Requirements

- Ruby (version 2.7 or later recommended)
- JSON gem (part of Ruby standard library)

No additional dependencies required.

## Error Handling

The script handles common errors gracefully:

- **File not found**: Reports which file is missing
- **Invalid JSON**: Shows parsing error details
- **Invalid arguments**: Displays help message

## Testing

A test scenario is included in the repository:

```bash
# Create test files (these commands create modified versions)
cp build/test-norm-tags.json build/test-v1.json
# ... modify test-v2.json ...

# Run tests
./detect_tag_changes.rb build/test-v1.json build/test-v2.json
./detect_tag_changes.rb --show-text build/test-v1.json build/test-v2.json
```

## Contributing

When modifying this script:

1. Maintain backward compatibility with existing tag JSON format
2. Add tests for new features
3. Update this README with new options or examples
4. Follow Ruby style guidelines (frozen_string_literal, snake_case, etc.)

## License

This script is part of the RISC-V documentation resources and follows the same license as the parent project.
